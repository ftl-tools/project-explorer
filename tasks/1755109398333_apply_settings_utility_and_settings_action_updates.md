# Apply Settings Utility spec and Settings action JSON behavior

- [ ] **Implement centralized Settings Utility:** Add a utility that provides get, update, watch, and format functions, operating at workspace scope when available and falling back to user scope. Ensure format() groups ftl-tools.* keys, injects defaults, and returns the URI and first key for reveal. (L) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility)
  - [x] **Scaffold module and API surface:** Create settings utility module with the recommended API shape and export types. (S) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility)
  - [x] **Scaffold module and API surface:** Create settings utility module with the recommended API shape and export types. (S) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility)
  - [x] **Implement get/update with scope handling:** Read/write settings at workspace scope when open; otherwise user scope; preserve existing values. Add unit tests. (S) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)
  - [x] **Implement watch with immediate emit:** Support key array/regex, invoke handler immediately with current values, and dispose cleanly. Add unit tests. (S) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)
  - [x] **Implement format() JSON grouper:** Open/create correct settings.json, group scattered ftl-tools.* keys contiguously, inject missing defaults without overwriting existing values, and return {openedUri, firstKey}. Add unit tests. (S) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)
  - [x] **Define defaults map for known keys:** Establish defaults for project-explorer.watchThese ([]), userDefinedTreeItems ([]), openDocsInPreview (true), brainstormingDocPath (""). Cover in tests. (S) Related docs: [Project Explorer - Tree Item Settings](design_docs/project_explorer.md#tree-item-settings), [Doc Tree Items - Custom Interactions](design_docs/tree_items/doc_tree_items/doc_tree_items.md#custom-interactions), [Title Action Icons - Open Brainstorming Doc](design_docs/title_action_icons/title_action_icons.md#open-brainstorming-doc)

- [x] **Update Settings title action to operate on JSON via utility:** Change the Settings command to call settingsUtil.format(), open the returned URI in an editor, and reveal the first ftl-tools.* key. Keep gear codicon and tooltip. (M) Related docs: [Title Action Icons - Settings](design_docs/title_action_icons/title_action_icons.md#settings), [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility)
  - [x] **Wire command implementation:** Replace current Settings UI behavior with JSON-based flow; handle multi-root by targeting the first workspace folder. (S) Related docs: [Title Action Icons - Settings](design_docs/title_action_icons/title_action_icons.md#settings)
  - [x] **No-workspace and missing-file handling:** When no workspace is open, open user settings.json; create settings.json if missing and ensure selection reveals the first ftl-tools.* key. (S) Related docs: [Title Action Icons - Settings](design_docs/title_action_icons/title_action_icons.md#settings), [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility)
  - [ ] **UI tests for Settings action:** Verify file opens to proper scope, grouping/injection occurred, and cursor reveals first ftl-tools.* key. (S) Related docs: [Title Action Icons - Settings](design_docs/title_action_icons/title_action_icons.md#settings), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)

- [x] **Refactor parser to consume settings via utility:** Replace direct configuration access with settingsUtil.get/watch for watchThese, userDefinedTreeItems/treeItems. Ensure re-parse on setting changes and maintain file watchers. (M) Related docs: [Project Explorer - Parser](design_docs/project_explorer.md#parser), [Project Explorer - Tree Item Settings](design_docs/project_explorer.md#tree-item-settings), [User-Defined Tree Items - Settings](design_docs/tree_items/user_defined_tree_items.md#settings), [Doc Tree Items - Settings](design_docs/tree_items/doc_tree_items/doc_tree_items.md#settings)
  - [x] **Swap to settingsUtil.get for initial values:** Read current settings and build initial parser output. (S) Related docs: [Project Explorer - Parser](design_docs/project_explorer.md#parser)
  - [x] **Add settingsUtil.watch for live updates:** Re-run parse when relevant keys change; keep existing FS watchers. (S) Related docs: [Project Explorer - Parser](design_docs/project_explorer.md#parser)
  - [x] **Honor both userDefinedTreeItems and treeItems:** Maintain backward-compatible passthrough in parsing logic with clear warnings. Add unit tests. (S) Related docs: [User-Defined Tree Items - Parsing](design_docs/tree_items/user_defined_tree_items.md#parsing), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)

- [x] **Use utility for doc preview behavior and brainstorming toggle:** Move openDocsInPreview and brainstormingDocPath reads/watches to settingsUtil to ensure runtime-reactivity. (M) Related docs: [Doc Tree Items - Custom Interactions](design_docs/tree_items/doc_tree_items/doc_tree_items.md#custom-interactions), [Title Action Icons - Open Brainstorming Doc](design_docs/title_action_icons/title_action_icons.md#open-brainstorming-doc)
  - [x] **Doc preview toggle via watch:** In ProjectExplorerProvider, watch openDocsInPreview and apply to Markdown items without reload. Add UI tests. (S) Related docs: [Doc Tree Items - Custom Interactions](design_docs/tree_items/doc_tree_items/doc_tree_items.md#custom-interactions), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)
  - [x] **Brainstorming action context via watch:** In extension activation, watch brainstormingDocPath to set projectExplorer.hasBrainstorming and ensure command opens correct file (absolute/relative). Add UI tests. (S) Related docs: [Title Action Icons - Open Brainstorming Doc](design_docs/title_action_icons/title_action_icons.md#open-brainstorming-doc), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)

- [ ] **Remove direct configuration access and finalize tests:** Sweep codebase for workspace.getConfiguration usages that should be routed through the utility, and ensure all new behaviors are covered by unit/UI tests. (S) Related docs: [VSCode Extensions - Settings and Settings Utility](design_docs/vscode_extensions.md#settings-and-settings-utility), [VSCode Extensions - Testing](design_docs/vscode_extensions.md#testing)
