"use strict";var F=Object.create;var k=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var R=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var O=(d,e)=>{for(var s in e)k(d,s,{get:e[s],enumerable:!0})},D=(d,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of M(e))!W.call(d,t)&&t!==s&&k(d,t,{get:()=>e[t],enumerable:!(r=$(e,t))||r.enumerable});return d};var C=(d,e,s)=>(s=d!=null?F(R(d)):{},D(e||!d||!d.__esModule?k(s,"default",{value:d,enumerable:!0}):s,d)),_=d=>D(k({},"__esModule",{value:!0}),d);var V={};O(V,{activate:()=>N,deactivate:()=>z});module.exports=_(V);var o=C(require("vscode"));var c=C(require("vscode")),v=C(require("path")),m=C(require("fs")),L=C(require("https")),H=C(require("http")),j=class{constructor(e){this.context=e;this.inflight=new Map;this.cacheDir=v.join(e.globalStorageUri.fsPath,"favicons"),this.indexPath=v.join(this.cacheDir,"index.json");try{m.mkdirSync(this.cacheDir,{recursive:!0})}catch{}this.index=this.readIndex()}async getIconForUrl(e){let s;try{let a=new URL(e);if(a.protocol!=="http:"&&a.protocol!=="https:")return;s=`${a.protocol}//${a.host}`}catch{return}let r=this.inflight.get(s);if(r)return r;let t=this.resolve(s,e).finally(()=>this.inflight.delete(s));return this.inflight.set(s,t),t}async resolve(e,s){let r=Date.now(),t=this.index[e];if(t){if(t.expiresAt&&t.expiresAt>r&&t.path&&m.existsSync(t.path))return c.Uri.file(t.path);if(t.negativeUntil&&t.negativeUntil>r)return}let a=`${e}/favicon.ico`,l=await this.tryFetchBuffer(a,5e3).catch(()=>{});if(l){let f=this.saveIcon(e,l,"ico");return this.index[e]={path:f,expiresAt:r+7*24*60*60*1e3},this.writeIndex(),c.Uri.file(f)}let h=await this.tryFetchText(s,5e3).catch(()=>{});if(h){let f=this.findIconHref(h);if(f)try{let p=new URL(s),n=new URL(f,p),i=await this.tryFetchBuffer(n.toString(),7e3).catch(()=>{});if(i){let w=this.guessExtFromUrlOrMime(n.toString()),g=this.saveIcon(e,i,w);return this.index[e]={path:g,expiresAt:r+7*24*60*60*1e3},this.writeIndex(),c.Uri.file(g)}}catch{}}this.index[e]={negativeUntil:r+24*60*60*1e3},this.writeIndex()}readIndex(){try{if(m.existsSync(this.indexPath)){let e=m.readFileSync(this.indexPath,"utf8");return JSON.parse(e)||{}}}catch{}return{}}writeIndex(){try{m.writeFileSync(this.indexPath,JSON.stringify(this.index,null,2),"utf8")}catch{}}saveIcon(e,s,r){let t=e.replace(/[^a-z0-9]/gi,"_"),a=v.join(this.cacheDir,`${t}.${r}`);return m.writeFileSync(a,s),a}guessExtFromUrlOrMime(e){let s=e.toLowerCase();return s.endsWith(".png")?"png":s.endsWith(".svg")||s.includes("image/svg")?"svg":s.endsWith(".jpg")||s.endsWith(".jpeg")?"jpg":s.endsWith(".ico")?"ico":"png"}async tryFetchText(e,s){return(await this.tryFetchBuffer(e,s)).toString("utf8")}async tryFetchBuffer(e,s){return new Promise((r,t)=>{let a=!1,l=setTimeout(()=>{a=!0,p==null||p.destroy(new Error("timeout")),t(new Error("timeout"))},s),p=(new URL(e).protocol==="https:"?L:H).get(e,n=>{let i=n.statusCode||0;if([301,302,303,307,308].includes(i)&&n.headers.location){clearTimeout(l),this.tryFetchBuffer(new URL(n.headers.location,e).toString(),s).then(r,t),n.resume();return}if(i<200||i>=300){clearTimeout(l),t(new Error(`HTTP ${i}`)),n.resume();return}let w=[];n.on("data",g=>w.push(Buffer.isBuffer(g)?g:Buffer.from(g))),n.on("end",()=>{a||(clearTimeout(l),r(Buffer.concat(w)))}),n.on("error",g=>{a||(clearTimeout(l),t(g))})});p.on("error",n=>{a||(clearTimeout(l),t(n))})})}findIconHref(e){let s=/<link\s+[^>]*rel=["']([^"']*)["'][^>]*href=["']([^"']+)["'][^>]*>/gi,r,t=[];for(;r=s.exec(e);){let a=r[1].toLowerCase(),l=r[2];a.includes("icon")&&t.push(l)}return t[0]}},U=class{constructor(e){this._onDidChangeTreeData=new c.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.items=new Map;this.parentById=new Map;this.childrenById=new Map;this.roots=[];this.favicons=new j(e),c.workspace.onDidChangeConfiguration(s=>{(s.affectsConfiguration("project-explorer.treeItems")||s.affectsConfiguration("project-explorer"))&&this.refresh()})}refresh(){this.rebuild(),this._onDidChangeTreeData.fire()}getTreeItem(e){return e}async getChildren(e){return this.items.size===0&&this.roots.length===0&&this.rebuild(),e?(this.childrenById.get(e.id||"")||[]).map(r=>this.items.get(r)).filter(Boolean):this.roots.map(r=>this.items.get(r)).filter(Boolean)}rebuild(){let e=new Set,r=c.workspace.getConfiguration("project-explorer").get("treeItems");this.items.clear(),this.parentById.clear(),this.childrenById.clear(),this.roots=[];let t=Array.isArray(r)?r:[];Array.isArray(r)||e.add("`project-explorer.treeItems` is not an array. Ignoring.");let a=[];for(let n of t){if(!n||typeof n!="object"){e.add("Ignored non-object entry in `project-explorer.treeItems`.");continue}let i=typeof n.id=="string"&&n.id.trim()?n.id.trim():"";if(!i){e.add("Ignored item with missing `id`.");continue}if(this.items.has(i)||a.find(u=>u.id===i)){e.add(`Duplicate id '${i}' found. Only the first occurrence will be used.`);continue}let w=typeof n.parentId=="string"&&n.parentId.trim()?n.parentId.trim():void 0,g=typeof n.label=="string"&&n.label.trim()?n.label.trim():void 0,S=typeof n.icon=="string"&&n.icon.trim()?n.icon.trim():void 0,E,I,T=n.typeAndPath,P=n.type_plus_path,y=typeof T=="string"&&T.trim()?T.trim():typeof P=="string"&&P.trim()?P.trim():"";if(!y&&typeof P=="string"&&P.trim()&&e.add(`Item '${i}' uses deprecated 'type_plus_path'. Please rename to 'typeAndPath'.`),y){let u=y.indexOf(":");if(u>0&&u<y.length-1){let x=y.slice(0,u),A=y.slice(u+1);["file","folder","url"].includes(x)?(E=x,I=A):e.add(`Item '${i}' has unknown type '${x}'. Treating as label-only item.`)}else e.add(`Item '${i}' has invalid typeAndPath '${y}'. Treating as label-only item.`)}let b=g;if(!b)if(E&&I)if(E==="url")try{let u=new URL(I),x=u.pathname.split("/").filter(Boolean);b=x.length>0?decodeURIComponent(x[x.length-1]):u.hostname}catch{b=I}else b=v.basename(this.resolveFsPath(I));else b=i;a.push({id:i,type:E,target:I,label:b,icon:S,parentId:w})}for(let n of a){let i=this.makeNode(n);this.items.set(n.id,i),this.parentById.set(n.id,n.parentId)}let l=new Set,h=new Set,f=new Set,p=n=>{if(h.has(n)){f.add(n);return}if(l.has(n))return;l.add(n),h.add(n);let i=this.parentById.get(n);i&&this.items.has(i)&&p(i),h.delete(n)};for(let n of this.items.keys())p(n);f.size>0&&e.add("Detected cyclical parent relationships. Items in cycles will be rendered at top level.");for(let n of f)this.parentById.delete(n);for(let n of this.items.keys())this.childrenById.set(n,[]);for(let[n,i]of this.parentById)i&&this.items.has(i)&&this.childrenById.get(i).push(n);for(let n of this.items.keys()){let i=this.parentById.get(n);(!i||!this.items.has(i))&&(i&&!this.items.has(i)&&e.add(`Parent '${i}' not found for item '${n}'. Rendering as top-level.`),this.roots.push(n))}for(let[n,i]of this.items){let w=(this.childrenById.get(n)||[]).length>0;i.collapsibleState=w?c.TreeItemCollapsibleState.Collapsed:c.TreeItemCollapsibleState.None,!i.command&&!i.iconPath&&(i.iconPath=new c.ThemeIcon("folder"))}e.size>0&&c.window.showWarningMessage(Array.from(e).join(" "))}makeNode(e){let{id:s}=e,r=e.type,t=e.target,a=e.label,l,h=new c.MarkdownString;if(r&&t?h.appendText(`${r}:${t}`):h.appendText(a),h.isTrusted=!0,e.icon){let p=this.parseCodicon(e.icon);if(p)l=new c.ThemeIcon(p);else{let n=this.resolveFsPath(e.icon);m.existsSync(n)?l=c.Uri.file(n):c.window.showWarningMessage(`Icon path not found for item '${s}': ${e.icon}. Falling back to default icon.`)}}else r==="url"&&(l=new c.ThemeIcon("globe"));let f=new B(a,c.TreeItemCollapsibleState.None);if(f.id=s,f.tooltip=h,f.iconPath=l,r==="file"&&t){let p=c.Uri.file(this.resolveFsPath(t));f.command={command:"vscode.open",title:"Open File",arguments:[p]}}else if(r==="folder"&&t){let p=c.Uri.file(this.resolveFsPath(t));f.command={command:"revealInExplorer",title:"Reveal in Explorer",arguments:[p]}}else r==="url"&&t&&(f.command={command:"projectExplorer.openExternal",title:"Open in Browser",arguments:[t]},e.icon||this.favicons.getIconForUrl(t).then(p=>{if(p){let n=this.items.get(s);n&&(n.iconPath=p,this._onDidChangeTreeData.fire(n))}}).catch(()=>{}));return f}parseCodicon(e){let s=/^\$\(([^)]+)\)$/.exec(e.trim());return s?s[1]:null}resolveFsPath(e){var t;let s=e.trim();if(s.startsWith("~")&&process.env.HOME&&(s=s.replace("~",process.env.HOME)),v.isAbsolute(s))return s;let r=(t=c.workspace.workspaceFolders)==null?void 0:t[0];return r?v.join(r.uri.fsPath,s):s}},B=class extends c.TreeItem{constructor(e,s){super(e,s)}};function N(d){let e=new U(d);o.window.registerTreeDataProvider("projectExplorer",e),o.window.onDidChangeActiveColorTheme(()=>{e.refresh()});let s=()=>{let t=o.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"",a=typeof t=="string"&&t.trim().length>0;o.commands.executeCommand("setContext","projectExplorer.hasBrainstorming",a)};s(),d.subscriptions.push(o.workspace.onDidChangeConfiguration(r=>{(r.affectsConfiguration("project-explorer.brainstormingDocPath")||r.affectsConfiguration("project-explorer"))&&s()})),d.subscriptions.push(o.commands.registerCommand("projectExplorer.openBrainstormingDoc",async()=>{var a;let t=(o.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"").trim();if(!t){o.window.showWarningMessage("No brainstormingDocPath is configured.");return}try{let l;if(t.startsWith("/")||/^[a-zA-Z]:\\/.test(t)||t.startsWith("~")){let p=t.startsWith("~")&&process.env.HOME?t.replace("~",process.env.HOME):t;l=o.Uri.file(p)}else{let p=(a=o.workspace.workspaceFolders)==null?void 0:a[0];if(!p){o.window.showErrorMessage("No workspace is open to resolve a relative brainstormingDocPath.");return}l=o.Uri.joinPath(p.uri,t)}let f=await o.workspace.openTextDocument(l);await o.window.showTextDocument(f,{preview:!1})}catch(l){let h=l instanceof Error?l.message:String(l);o.window.showErrorMessage(`Unable to open brainstorming document: ${h}`)}})),d.subscriptions.push(o.commands.registerCommand("projectExplorer.openExternal",async r=>{try{let t=o.Uri.parse(r);await o.env.openExternal(t)}catch(t){let a=t instanceof Error?t.message:String(t);o.window.showErrorMessage(`Unable to open URL: ${a}`)}})),d.subscriptions.push(o.commands.registerCommand("projectExplorer.openHelp",async()=>{let r=d.extension.id,t=o.Uri.parse(`vscode:extension/${r}`);await o.commands.executeCommand("vscode.open",t)})),d.subscriptions.push(o.commands.registerCommand("projectExplorer.openSettings",async()=>{var t;(((t=o.workspace.workspaceFolders)==null?void 0:t.length)||0)>0?(await o.commands.executeCommand("workbench.action.openWorkspaceSettings"),await o.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer")):(o.window.showInformationMessage("Workspace settings are unavailable. Opening User settings."),await o.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer"))})),d.subscriptions.push(o.commands.registerCommand("projectExplorer.configureTreeItems",async()=>{await o.commands.executeCommand("workbench.action.openSettings","project-explorer.treeItems")})),d.subscriptions.push(o.commands.registerCommand("projectExplorer.collapseAll",async()=>{await o.commands.executeCommand("workbench.actions.treeView.projectExplorer.collapseAll")}))}function z(){}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
