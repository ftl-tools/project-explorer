"use strict";var K=Object.create;var M=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var Y=Object.getPrototypeOf,q=Object.prototype.hasOwnProperty;var ee=(c,e)=>{for(var n in e)M(c,n,{get:e[n],enumerable:!0})},H=(c,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of X(e))!q.call(c,s)&&s!==n&&M(c,s,{get:()=>e[s],enumerable:!(o=Q(e,s))||o.enumerable});return c};var C=(c,e,n)=>(n=c!=null?K(Y(c)):{},H(e||!c||!c.__esModule?M(n,"default",{value:c,enumerable:!0}):n,c)),te=c=>H(M({},"__esModule",{value:!0}),c);var de={};ee(de,{activate:()=>ce,deactivate:()=>ae});module.exports=te(de);var p=C(require("vscode"));var h=C(require("vscode")),$=C(require("path")),D=C(require("fs")),ne=C(require("https")),re=C(require("http")),z=require("child_process"),W=class{constructor(e){this.context=e;this.inflight=new Map;this.cacheDir=$.join(e.globalStorageUri.fsPath,"favicons"),this.indexPath=$.join(this.cacheDir,"index.json");try{D.mkdirSync(this.cacheDir,{recursive:!0})}catch{}this.index=this.readIndex()}async getIconForUrl(e){let n;try{let u=new URL(e);if(u.protocol!=="http:"&&u.protocol!=="https:")return;n=`${u.protocol}//${u.host}`}catch{return}let o=this.inflight.get(n);if(o)return o;let s=this.resolve(n,e).finally(()=>this.inflight.delete(n));return this.inflight.set(n,s),s}async resolve(e,n){let o=Date.now(),s=this.index[e];if(s){if(s.expiresAt&&s.expiresAt>o&&s.path&&D.existsSync(s.path))return h.Uri.file(s.path);if(s.negativeUntil&&s.negativeUntil>o)return}let u=`${e}/favicon.ico`,m=await this.tryFetchBuffer(u,5e3).catch(()=>{});if(m){let t=this.saveIcon(e,m,"ico");return this.index[e]={path:t,expiresAt:o+7*24*60*60*1e3},this.writeIndex(),h.Uri.file(t)}let l=await this.tryFetchText(n,5e3).catch(()=>{});if(l){let t=this.findIconHref(l);if(t)try{let r=new URL(n),d=new URL(t,r),g=await this.tryFetchBuffer(d.toString(),7e3).catch(()=>{});if(g){let y=this.guessExtFromUrlOrMime(d.toString()),f=this.saveIcon(e,g,y);return this.index[e]={path:f,expiresAt:o+7*24*60*60*1e3},this.writeIndex(),h.Uri.file(f)}}catch{}}this.index[e]={negativeUntil:o+24*60*60*1e3},this.writeIndex()}readIndex(){try{if(D.existsSync(this.indexPath)){let e=D.readFileSync(this.indexPath,"utf8");return JSON.parse(e)||{}}}catch{}return{}}writeIndex(){try{D.writeFileSync(this.indexPath,JSON.stringify(this.index,null,2),"utf8")}catch{}}saveIcon(e,n,o){let s=e.replace(/[^a-z0-9]/gi,"_"),u=$.join(this.cacheDir,`${s}.${o}`);return D.writeFileSync(u,n),u}guessExtFromUrlOrMime(e){let n=e.toLowerCase();return n.endsWith(".png")?"png":n.endsWith(".svg")||n.includes("image/svg")?"svg":n.endsWith(".jpg")||n.endsWith(".jpeg")?"jpg":n.endsWith(".ico")?"ico":"png"}async tryFetchText(e,n){return(await this.tryFetchBuffer(e,n)).toString("utf8")}async tryFetchBuffer(e,n){return new Promise((o,s)=>{let u=!1,m=setTimeout(()=>{u=!0,r==null||r.destroy(new Error("timeout")),s(new Error("timeout"))},n),r=(new URL(e).protocol==="https:"?ne:re).get(e,d=>{let g=d.statusCode||0;if([301,302,303,307,308].includes(g)&&d.headers.location){clearTimeout(m),this.tryFetchBuffer(new URL(d.headers.location,e).toString(),n).then(o,s),d.resume();return}if(g<200||g>=300){clearTimeout(m),s(new Error(`HTTP ${g}`)),d.resume();return}let y=[];d.on("data",f=>y.push(Buffer.isBuffer(f)?f:Buffer.from(f))),d.on("end",()=>{u||(clearTimeout(m),o(Buffer.concat(y)))}),d.on("error",f=>{u||(clearTimeout(m),s(f))})});r.on("error",d=>{u||(clearTimeout(m),s(d))})})}findIconHref(e){let n=/<link\s+[^>]*rel=["']([^"']*)["'][^>]*href=["']([^"']+)["'][^>]*>/gi,o,s=[];for(;o=n.exec(e);){let u=o[1].toLowerCase(),m=o[2];u.includes("icon")&&s.push(m)}return s[0]}},N=class{constructor(e){this._onDidChangeTreeData=new h.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.items=new Map;this.treeFileUri=null;this.watcher=null;this.parentById=new Map;this.childrenById=new Map;this.roots=[];this.running=new Set;this.scriptIds=new Set;var o;this.favicons=new W(e);let n=(o=h.workspace.workspaceFolders)==null?void 0:o[0];if(n){this.treeFileUri=h.Uri.joinPath(n.uri,".vscode","project_explorer","tree_items.json");let s=new h.RelativePattern(n,".vscode/project_explorer/tree_items.json");this.watcher=h.workspace.createFileSystemWatcher(s),this.watcher.onDidChange(()=>this.refresh()),this.watcher.onDidCreate(()=>this.refresh())}h.workspace.onDidChangeConfiguration(s=>{(s.affectsConfiguration("project-explorer.treeItems")||s.affectsConfiguration("project-explorer"))&&this.refresh()})}refresh(){this.rebuild(),this._onDidChangeTreeData.fire()}getTreeItem(e){return e}async getChildren(e){return this.items.size===0&&this.roots.length===0&&this.rebuild(),e?(this.childrenById.get(e.id||"")||[]).map(o=>this.items.get(o)).filter(Boolean):this.roots.map(o=>this.items.get(o)).filter(Boolean)}rebuild(){let e=new Set;this.items.clear(),this.parentById.clear(),this.childrenById.clear(),this.roots=[],this.scriptIds.clear();let n=this.readTreeItemsFromFile(),o=[];for(let t of n){if(!t||typeof t!="object"){e.add("Ignored non-object entry in `project-explorer.treeItems`.");continue}let r=typeof t.id=="string"&&t.id.trim()?t.id.trim():"",d=typeof t.typeAndPath=="string"?t.typeAndPath:void 0;if(!r){e.add("Ignored item with missing `id`.");continue}if(this.items.has(r)||o.find(S=>S.id===r)){e.add(`Duplicate id '${r}' found. Only the first occurrence will be used.`);continue}let g=typeof t.parentId=="string"&&t.parentId.trim()?t.parentId.trim():void 0,y=typeof t.label=="string"&&t.label.trim()?t.label.trim():void 0,f=typeof t.icon=="string"&&t.icon.trim()?t.icon.trim():void 0,a,v,I=d,x=t.type_plus_path,i=typeof I=="string"&&I.trim()?I.trim():typeof x=="string"&&x.trim()?x.trim():"";if(!i&&typeof x=="string"&&x.trim()&&e.add(`Item '${r}' uses deprecated 'type_plus_path'. Please rename to 'typeAndPath'.`),i){let S=i.indexOf(":");if(S>0&&S<i.length-1){let P=i.slice(0,S),U=i.slice(S+1);["file","folder","url","script"].includes(P)?(a=P,v=U):e.add(`Item '${r}' has unknown type '${P}'. Treating as label-only item.`)}else e.add(`Item '${r}' has invalid typeAndPath '${i}'. Treating as label-only item.`)}let b=y;if(!b)if(a&&v)if(a==="url")try{let S=new URL(v),P=S.pathname.split("/").filter(Boolean);b=P.length>0?decodeURIComponent(P[P.length-1]):S.hostname}catch{b=v}else a==="file"||a==="folder"?b=$.basename(this.resolveFsPath(v)):a==="script"&&(b=v);else b=r;let w={id:r,type:a,target:v,label:b,icon:f,parentId:g??void 0};if(a==="script"){let S=typeof t.cwd=="string"&&t.cwd.trim()?t.cwd.trim():void 0,P=t.env,U;if(P&&typeof P=="object"&&!Array.isArray(P)){U={};for(let[A,R]of Object.entries(P))typeof R=="string"&&(U[A]=R)}w.cwd=S,w.env=U,this.scriptIds.add(r)}o.push(w)}for(let t of o){let r=this.makeNode(t);this.items.set(t.id,r),this.parentById.set(t.id,t.parentId||void 0)}for(let[t,r]of Array.from(this.parentById.entries()))r&&this.scriptIds.has(r)&&(e.add(`Item '${t}' cannot have script parent '${r}'. Rendering as top-level.`),this.parentById.set(t,void 0));let s=new Set,u=new Set,m=new Set,l=t=>{if(u.has(t)){m.add(t);return}if(s.has(t))return;s.add(t),u.add(t);let r=this.parentById.get(t);r&&this.items.has(r)&&l(r),u.delete(t)};for(let t of this.items.keys())l(t);m.size>0&&e.add("Detected cyclical parent relationships. Items in cycles will be rendered at top level.");for(let t of m)this.parentById.delete(t);for(let t of this.items.keys())this.childrenById.set(t,[]);for(let[t,r]of this.parentById)r&&this.items.has(r)&&this.childrenById.get(r).push(t);for(let t of this.items.keys()){let r=this.parentById.get(t);(!r||!this.items.has(r))&&(r&&!this.items.has(r)&&e.add(`Parent '${r}' not found for item '${t}'. Rendering as top-level.`),this.roots.push(t))}for(let[t,r]of this.items){let d=(this.childrenById.get(t)||[]).length>0;r.collapsibleState=d?h.TreeItemCollapsibleState.Collapsed:h.TreeItemCollapsibleState.None,!r.command&&!r.iconPath&&!("script"in r)&&(r.iconPath=new h.ThemeIcon("folder"))}e.size>0&&h.window.showWarningMessage(Array.from(e).join(" "))}makeNode(e){let{id:n}=e,o=e.type,s=e.target,u=e.label,m,l=new h.MarkdownString;if(o&&s?l.appendText(`${o}:${s}`):l.appendText(u),l.isTrusted=!0,e.icon){let r=this.parseCodicon(e.icon);if(r)m=new h.ThemeIcon(r);else{let d=this.resolveFsPath(e.icon);D.existsSync(d)?m=h.Uri.file(d):h.window.showWarningMessage(`Icon path not found for item '${n}': ${e.icon}. Falling back to default icon.`)}}else o==="url"?m=new h.ThemeIcon("globe"):o==="script"&&(m=new h.ThemeIcon("run"));let t=new O(u,h.TreeItemCollapsibleState.None);if(t.id=n,t.tooltip=l,t.iconPath=m,o==="file"&&s){let r=h.Uri.file(this.resolveFsPath(s));t.command={command:"vscode.open",title:"Open File",arguments:[r]}}else if(o==="folder"&&s){let r=h.Uri.file(this.resolveFsPath(s));t.command={command:"revealInExplorer",title:"Reveal in Explorer",arguments:[r]}}else o==="url"&&s?(t.command={command:"projectExplorer.openExternal",title:"Open in Browser",arguments:[s]},e.icon||this.favicons.getIconForUrl(s).then(r=>{if(r){let d=this.items.get(n);d&&(d.iconPath=r,this._onDidChangeTreeData.fire(d))}}).catch(()=>{})):o==="script"&&s&&(t.script={cmd:s,cwd:e.cwd,env:e.env},t.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[n]});return t}async runScriptById(e){var g,y;let n=this.items.get(e);if(!n||!n.script||this.running.has(e))return;let o=n.label;this.running.add(e),n.command=void 0,n.label=`${o}...`,this._onDidChangeTreeData.fire(n);let s=n.script.cwd?this.resolveFsPath(n.script.cwd):void 0;if(s&&!D.existsSync(s)){h.window.showErrorMessage(`Invalid cwd for script '${e}': ${s}`),this.running.delete(e),n.label=o,n.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[e]},this._onDidChangeTreeData.fire(n);return}let u={...process.env,...n.script.env||{}},m=(0,z.spawn)(n.script.cmd,{shell:!0,cwd:s,env:u}),l="",t="";(g=m.stdout)==null||g.on("data",f=>{l+=f instanceof Buffer?f.toString("utf8"):String(f)}),(y=m.stderr)==null||y.on("data",f=>{t+=f instanceof Buffer?f.toString("utf8"):String(f)});let r=!1,d=(f,a)=>{if(!r)if(r=!0,f){let v=(a??l).trim();h.window.showInformationMessage(v.length>0?v:`Script '${e}' completed successfully.`)}else{let v=(a??t).trim();h.window.showErrorMessage(v.length>0?v:`Script '${e}' failed.`)}this.running.delete(e),n.label=o,n.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[e]},this._onDidChangeTreeData.fire(n)};m.on("error",f=>{d(!1,`Failed to start script '${e}': ${f instanceof Error?f.message:String(f)}`)}),m.on("close",f=>{d(f===0)})}readTreeItemsFromFile(){try{if(this.treeFileUri){let e=this.treeFileUri.fsPath;if(D.existsSync(e)){let n=D.readFileSync(e,"utf8"),o=JSON.parse(n);return Array.isArray(o)?o:[]}}}catch{}return[]}parseCodicon(e){let n=/^\$\(([^)]+)\)$/.exec(e.trim());return n?n[1]:null}resolveFsPath(e){var s;let n=e.trim();if(n.startsWith("~")&&process.env.HOME&&(n=n.replace("~",process.env.HOME)),$.isAbsolute(n))return n;let o=(s=h.workspace.workspaceFolders)==null?void 0:s[0];return o?$.join(o.uri.fsPath,n):n}},O=class extends h.TreeItem{constructor(e,n){super(e,n)}};var B=C(require("vscode")),j=C(require("fs")),k=C(require("path")),V=c=>{try{j.mkdirSync(c,{recursive:!0})}catch{}},se=(c,e)=>{let n=`${c}.tmp`;j.writeFileSync(n,JSON.stringify(e,null,2),"utf8"),j.renameSync(n,c)};function Z(c){var f;let e=(f=B.workspace.workspaceFolders)==null?void 0:f[0],n=k.join((e==null?void 0:e.uri.fsPath)||"",".vscode","project_explorer");e&&V(n);let o=e?k.join(n,"parser_output.json"):"",s,u=()=>{s&&clearTimeout(s),s=setTimeout(y,150)},m=B.workspace.onDidChangeConfiguration(a=>{(a.affectsConfiguration("project-explorer.watchThese")||a.affectsConfiguration("project-explorer.userDefinedTreeItems")||a.affectsConfiguration("project-explorer.treeItems"))&&u()}),l=[],t=a=>{if(!e)return;let I=(k.isAbsolute(a)?a:k.join(e.uri.fsPath,a)).replace(/\\/g,"/"),x=new B.RelativePattern(e,k.relative(e.uri.fsPath,I)+"/**"),i=B.workspace.createFileSystemWatcher(x);l.push(i),i.onDidChange(u),i.onDidCreate(u),i.onDidDelete(u)},r=a=>{try{let v=j.readFileSync(a,"utf8"),I=/^#\s+(.+)$/m.exec(v);return I?I[1].trim():""}catch{return""}},d=a=>{let v=j.existsSync(a)?j.statSync(a):void 0;if(!v)return{path:g(a),type:"resource",title:"",children:[]};if(v.isDirectory()){let I=[];for(let x of j.readdirSync(a)){if(x===".git"||x==="node_modules")continue;let i=k.join(a,x);I.push(d(i))}return{path:g(a),type:"folder",title:"",children:I}}return a.toLowerCase().endsWith(".md")?{path:g(a),type:"doc",title:r(a),children:[]}:{path:g(a),type:"resource",title:"",children:[]}},g=a=>e?k.relative(e.uri.fsPath,a):a,y=()=>{var i;let a=B.workspace.getConfiguration("project-explorer"),v=a.get("watchThese")||[],I=(a.get("userDefinedTreeItems")||a.get("treeItems")||[]).filter(Boolean),x={};if(I.length>0&&(x.userDefined=I),e){for(;l.length;)(i=l.pop())==null||i.dispose();let b={};for(let w of v)if(!(!w||typeof w!="object")&&w.type==="docs"&&typeof w.path=="string"&&w.path.trim()){let S=k.isAbsolute(w.path)?w.path:k.join(e.uri.fsPath,w.path);t(w.path),b[w.path]=d(S)}Object.keys(b).length>0&&(x.docs=b),V(n),se(o,x)}};return e&&y(),c.subscriptions.push(m),{dispose(){var a;for(;l.length;)(a=l.pop())==null||a.dispose();s&&clearTimeout(s)}}}var _=C(require("vscode")),F=C(require("fs")),E=C(require("path")),ie=c=>{try{F.mkdirSync(c,{recursive:!0})}catch{}},oe=(c,e)=>{let n=`${c}.tmp`;F.writeFileSync(n,JSON.stringify(e,null,2),"utf8"),F.renameSync(n,c)};function G(c){var r;let e=(r=_.workspace.workspaceFolders)==null?void 0:r[0];if(!e)return{dispose(){}};let n=e.uri.fsPath,o=E.join(n,".vscode","project_explorer"),s=E.join(o,"parser_output.json"),u=E.join(o,"tree_items.json");ie(o);let m=new _.RelativePattern(e,".vscode/project_explorer/parser_output.json"),l=_.workspace.createFileSystemWatcher(m),t=()=>{let d;try{let i=F.readFileSync(s,"utf8");d=JSON.parse(i)}catch{return}if(!d)return;let g=[],y=new Set;if(Array.isArray(d.userDefined))for(let i of d.userDefined)!i||typeof i!="object"||typeof i.id!="string"||!i.id||y.has(i.id)||(y.add(i.id),g.push({id:i.id,typeAndPath:i.typeAndPath,icon:i.icon,label:i.label,parentId:i.parentId,cwd:i.cwd,env:i.env}));let f=d.docs||{},a=(i,b)=>{let w=E.basename(i.path);if(i.type==="folder"){let P=i.children.find(T=>T.type==="doc"&&/README\.md$/i.test(T.path)),U=i.children.find(T=>T.type==="doc"&&E.basename(E.dirname(T.path)).replace(/\.[^/.]+$/,"")===E.basename(i.path)),A=P||U;if(A){let T=I(A);v(A,b);for(let J of i.children)J!==A&&a(J,T);return}let R=w;x({id:R,typeAndPath:`folder:${i.path}`,icon:void 0,label:L(w),parentId:b});for(let T of i.children)a(T,R);return}if(i.type==="doc"){v(i,b);return}x({id:w,typeAndPath:`file:${i.path}`,icon:void 0,label:L(w.replace(/\.[^.]+$/,"")),parentId:b})},v=(i,b)=>{let w=I(i),S=i.title&&i.title.trim()?i.title.trim():L(E.basename(i.path,".md"));x({id:w,typeAndPath:`file:${i.path}`,icon:void 0,label:S,parentId:b})},I=i=>E.basename(i.path,".md"),x=i=>{!i.id||y.has(i.id)||(y.add(i.id),g.push({id:i.id,typeAndPath:i.typeAndPath,icon:i.icon,label:i.label,parentId:i.parentId||void 0}))};for(let i of Object.keys(f))a(f[i],null);oe(u,g)};return l.onDidCreate(t,null,c.subscriptions),l.onDidChange(t,null,c.subscriptions),l.onDidDelete(()=>{},null,c.subscriptions),F.existsSync(s)&&t(),{dispose(){l.dispose()}}}function L(c){return c.replace(/[._-]+/g," ").replace(/([a-z])([A-Z])/g,"$1 $2").replace(/(\d)([A-Za-z])/g,"$1 $2").replace(/([A-Za-z])(\d)/g,"$1 $2").split(/\s+/).filter(Boolean).map(n=>/^[0-9]+$/.test(n)?n.toUpperCase():n[0].toUpperCase()+n.slice(1).toLowerCase()).join(" ")}async function ce(c){var m;let e=new N(c),n=(m=p.workspace.workspaceFolders)==null?void 0:m[0];if(n){let l=p.Uri.joinPath(n.uri,".vscode","project_explorer");await p.workspace.fs.createDirectory(l)}let o=Z(c),s=G(c);p.window.registerTreeDataProvider("projectExplorer",e),p.window.onDidChangeActiveColorTheme(()=>{e.refresh()});let u=()=>{let t=p.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"",r=typeof t=="string"&&t.trim().length>0;p.commands.executeCommand("setContext","projectExplorer.hasBrainstorming",r)};u(),c.subscriptions.push(p.workspace.onDidChangeConfiguration(l=>{(l.affectsConfiguration("project-explorer.brainstormingDocPath")||l.affectsConfiguration("project-explorer"))&&u()})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.openBrainstormingDoc",async()=>{var r;let t=(p.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"").trim();if(!t){p.window.showWarningMessage("No brainstormingDocPath is configured.");return}try{let d;if(t.startsWith("/")||/^[a-zA-Z]:\\/.test(t)||t.startsWith("~")){let f=t.startsWith("~")&&process.env.HOME?t.replace("~",process.env.HOME):t;d=p.Uri.file(f)}else{let f=(r=p.workspace.workspaceFolders)==null?void 0:r[0];if(!f){p.window.showErrorMessage("No workspace is open to resolve a relative brainstormingDocPath.");return}d=p.Uri.joinPath(f.uri,t)}let y=await p.workspace.openTextDocument(d);await p.window.showTextDocument(y,{preview:!1})}catch(d){let g=d instanceof Error?d.message:String(d);p.window.showErrorMessage(`Unable to open brainstorming document: ${g}`)}})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.openExternal",async l=>{try{let t=p.Uri.parse(l);await p.env.openExternal(t)}catch(t){let r=t instanceof Error?t.message:String(t);p.window.showErrorMessage(`Unable to open URL: ${r}`)}})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.runScript",async l=>{await e.runScriptById(l)})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.openHelp",async()=>{let l=c.extension.id,t=p.Uri.parse(`vscode:extension/${l}`);await p.commands.executeCommand("vscode.open",t)})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.openSettings",async()=>{var t;(((t=p.workspace.workspaceFolders)==null?void 0:t.length)||0)>0?(await p.commands.executeCommand("workbench.action.openWorkspaceSettings"),await p.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer")):(p.window.showInformationMessage("Workspace settings are unavailable. Opening User settings."),await p.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer"))})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.configureTreeItems",async()=>{await p.commands.executeCommand("workbench.action.openSettings","project-explorer.treeItems")})),c.subscriptions.push(p.commands.registerCommand("projectExplorer.collapseAll",async()=>{await p.commands.executeCommand("workbench.actions.treeView.projectExplorer.collapseAll")}))}function ae(){}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
