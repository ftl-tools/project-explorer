"use strict";var W=Object.create;var k=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var H=(l,e)=>{for(var t in e)k(l,t,{get:e[t],enumerable:!0})},R=(l,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of _(e))!N.call(l,r)&&r!==t&&k(l,r,{get:()=>e[r],enumerable:!(s=O(e,r))||s.enumerable});return l};var E=(l,e,t)=>(t=l!=null?W(L(l)):{},R(e||!l||!l.__esModule?k(t,"default",{value:l,enumerable:!0}):t,l)),z=l=>R(k({},"__esModule",{value:!0}),l);var K={};H(K,{activate:()=>Z,deactivate:()=>G});module.exports=z(K);var o=E(require("vscode"));var d=E(require("vscode")),x=E(require("path")),v=E(require("fs")),V=E(require("https")),J=E(require("http")),F=require("child_process"),D=class{constructor(e){this.context=e;this.inflight=new Map;this.cacheDir=x.join(e.globalStorageUri.fsPath,"favicons"),this.indexPath=x.join(this.cacheDir,"index.json");try{v.mkdirSync(this.cacheDir,{recursive:!0})}catch{}this.index=this.readIndex()}async getIconForUrl(e){let t;try{let c=new URL(e);if(c.protocol!=="http:"&&c.protocol!=="https:")return;t=`${c.protocol}//${c.host}`}catch{return}let s=this.inflight.get(t);if(s)return s;let r=this.resolve(t,e).finally(()=>this.inflight.delete(t));return this.inflight.set(t,r),r}async resolve(e,t){let s=Date.now(),r=this.index[e];if(r){if(r.expiresAt&&r.expiresAt>s&&r.path&&v.existsSync(r.path))return d.Uri.file(r.path);if(r.negativeUntil&&r.negativeUntil>s)return}let c=`${e}/favicon.ico`,a=await this.tryFetchBuffer(c,5e3).catch(()=>{});if(a){let h=this.saveIcon(e,a,"ico");return this.index[e]={path:h,expiresAt:s+7*24*60*60*1e3},this.writeIndex(),d.Uri.file(h)}let m=await this.tryFetchText(t,5e3).catch(()=>{});if(m){let h=this.findIconHref(m);if(h)try{let p=new URL(t),n=new URL(h,p),i=await this.tryFetchBuffer(n.toString(),7e3).catch(()=>{});if(i){let w=this.guessExtFromUrlOrMime(n.toString()),f=this.saveIcon(e,i,w);return this.index[e]={path:f,expiresAt:s+7*24*60*60*1e3},this.writeIndex(),d.Uri.file(f)}}catch{}}this.index[e]={negativeUntil:s+24*60*60*1e3},this.writeIndex()}readIndex(){try{if(v.existsSync(this.indexPath)){let e=v.readFileSync(this.indexPath,"utf8");return JSON.parse(e)||{}}}catch{}return{}}writeIndex(){try{v.writeFileSync(this.indexPath,JSON.stringify(this.index,null,2),"utf8")}catch{}}saveIcon(e,t,s){let r=e.replace(/[^a-z0-9]/gi,"_"),c=x.join(this.cacheDir,`${r}.${s}`);return v.writeFileSync(c,t),c}guessExtFromUrlOrMime(e){let t=e.toLowerCase();return t.endsWith(".png")?"png":t.endsWith(".svg")||t.includes("image/svg")?"svg":t.endsWith(".jpg")||t.endsWith(".jpeg")?"jpg":t.endsWith(".ico")?"ico":"png"}async tryFetchText(e,t){return(await this.tryFetchBuffer(e,t)).toString("utf8")}async tryFetchBuffer(e,t){return new Promise((s,r)=>{let c=!1,a=setTimeout(()=>{c=!0,p==null||p.destroy(new Error("timeout")),r(new Error("timeout"))},t),p=(new URL(e).protocol==="https:"?V:J).get(e,n=>{let i=n.statusCode||0;if([301,302,303,307,308].includes(i)&&n.headers.location){clearTimeout(a),this.tryFetchBuffer(new URL(n.headers.location,e).toString(),t).then(s,r),n.resume();return}if(i<200||i>=300){clearTimeout(a),r(new Error(`HTTP ${i}`)),n.resume();return}let w=[];n.on("data",f=>w.push(Buffer.isBuffer(f)?f:Buffer.from(f))),n.on("end",()=>{c||(clearTimeout(a),s(Buffer.concat(w)))}),n.on("error",f=>{c||(clearTimeout(a),r(f))})});p.on("error",n=>{c||(clearTimeout(a),r(n))})})}findIconHref(e){let t=/<link\s+[^>]*rel=["']([^"']*)["'][^>]*href=["']([^"']+)["'][^>]*>/gi,s,r=[];for(;s=t.exec(e);){let c=s[1].toLowerCase(),a=s[2];c.includes("icon")&&r.push(a)}return r[0]}},T=class{constructor(e){this._onDidChangeTreeData=new d.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.items=new Map;this.parentById=new Map;this.childrenById=new Map;this.roots=[];this.running=new Set;this.scriptIds=new Set;this.favicons=new D(e),d.workspace.onDidChangeConfiguration(t=>{(t.affectsConfiguration("project-explorer.treeItems")||t.affectsConfiguration("project-explorer"))&&this.refresh()})}refresh(){this.rebuild(),this._onDidChangeTreeData.fire()}getTreeItem(e){return e}async getChildren(e){return this.items.size===0&&this.roots.length===0&&this.rebuild(),e?(this.childrenById.get(e.id||"")||[]).map(s=>this.items.get(s)).filter(Boolean):this.roots.map(s=>this.items.get(s)).filter(Boolean)}rebuild(){let e=new Set,s=d.workspace.getConfiguration("project-explorer").get("treeItems");this.items.clear(),this.parentById.clear(),this.childrenById.clear(),this.roots=[],this.scriptIds.clear();let r=Array.isArray(s)?s:[];Array.isArray(s)||e.add("`project-explorer.treeItems` is not an array. Ignoring.");let c=[];for(let n of r){if(!n||typeof n!="object"){e.add("Ignored non-object entry in `project-explorer.treeItems`.");continue}let i=typeof n.id=="string"&&n.id.trim()?n.id.trim():"";if(!i){e.add("Ignored item with missing `id`.");continue}if(this.items.has(i)||c.find(y=>y.id===i)){e.add(`Duplicate id '${i}' found. Only the first occurrence will be used.`);continue}let w=typeof n.parentId=="string"&&n.parentId.trim()?n.parentId.trim():void 0,f=typeof n.label=="string"&&n.label.trim()?n.label.trim():void 0,j=typeof n.icon=="string"&&n.icon.trim()?n.icon.trim():void 0,g,I,B=n.typeAndPath,S=n.type_plus_path,b=typeof B=="string"&&B.trim()?B.trim():typeof S=="string"&&S.trim()?S.trim():"";if(!b&&typeof S=="string"&&S.trim()&&e.add(`Item '${i}' uses deprecated 'type_plus_path'. Please rename to 'typeAndPath'.`),b){let y=b.indexOf(":");if(y>0&&y<b.length-1){let u=b.slice(0,y),P=b.slice(y+1);["file","folder","url","script"].includes(u)?(g=u,I=P):e.add(`Item '${i}' has unknown type '${u}'. Treating as label-only item.`)}else e.add(`Item '${i}' has invalid typeAndPath '${b}'. Treating as label-only item.`)}let C=f;if(!C)if(g&&I)if(g==="url")try{let y=new URL(I),u=y.pathname.split("/").filter(Boolean);C=u.length>0?decodeURIComponent(u[u.length-1]):y.hostname}catch{C=I}else g==="file"||g==="folder"?C=x.basename(this.resolveFsPath(I)):g==="script"&&(C=I);else C=i;let U={id:i,type:g,target:I,label:C,icon:j,parentId:w};if(g==="script"){let y=typeof n.cwd=="string"&&n.cwd.trim()?n.cwd.trim():void 0,u=n.env,P;if(u&&typeof u=="object"&&!Array.isArray(u)){P={};for(let[M,A]of Object.entries(u))typeof A=="string"&&(P[M]=A)}U.cwd=y,U.env=P,this.scriptIds.add(i)}c.push(U)}for(let n of c){let i=this.makeNode(n);this.items.set(n.id,i),this.parentById.set(n.id,n.parentId)}for(let[n,i]of Array.from(this.parentById.entries()))i&&this.scriptIds.has(i)&&(e.add(`Item '${n}' cannot have script parent '${i}'. Rendering as top-level.`),this.parentById.set(n,void 0));let a=new Set,m=new Set,h=new Set,p=n=>{if(m.has(n)){h.add(n);return}if(a.has(n))return;a.add(n),m.add(n);let i=this.parentById.get(n);i&&this.items.has(i)&&p(i),m.delete(n)};for(let n of this.items.keys())p(n);h.size>0&&e.add("Detected cyclical parent relationships. Items in cycles will be rendered at top level.");for(let n of h)this.parentById.delete(n);for(let n of this.items.keys())this.childrenById.set(n,[]);for(let[n,i]of this.parentById)i&&this.items.has(i)&&this.childrenById.get(i).push(n);for(let n of this.items.keys()){let i=this.parentById.get(n);(!i||!this.items.has(i))&&(i&&!this.items.has(i)&&e.add(`Parent '${i}' not found for item '${n}'. Rendering as top-level.`),this.roots.push(n))}for(let[n,i]of this.items){let w=(this.childrenById.get(n)||[]).length>0;i.collapsibleState=w?d.TreeItemCollapsibleState.Collapsed:d.TreeItemCollapsibleState.None,!i.command&&!i.iconPath&&!("script"in i)&&(i.iconPath=new d.ThemeIcon("folder"))}e.size>0&&d.window.showWarningMessage(Array.from(e).join(" "))}makeNode(e){let{id:t}=e,s=e.type,r=e.target,c=e.label,a,m=new d.MarkdownString;if(s&&r?m.appendText(`${s}:${r}`):m.appendText(c),m.isTrusted=!0,e.icon){let p=this.parseCodicon(e.icon);if(p)a=new d.ThemeIcon(p);else{let n=this.resolveFsPath(e.icon);v.existsSync(n)?a=d.Uri.file(n):d.window.showWarningMessage(`Icon path not found for item '${t}': ${e.icon}. Falling back to default icon.`)}}else s==="url"?a=new d.ThemeIcon("globe"):s==="script"&&(a=new d.ThemeIcon("run"));let h=new $(c,d.TreeItemCollapsibleState.None);if(h.id=t,h.tooltip=m,h.iconPath=a,s==="file"&&r){let p=d.Uri.file(this.resolveFsPath(r));h.command={command:"vscode.open",title:"Open File",arguments:[p]}}else if(s==="folder"&&r){let p=d.Uri.file(this.resolveFsPath(r));h.command={command:"revealInExplorer",title:"Reveal in Explorer",arguments:[p]}}else s==="url"&&r?(h.command={command:"projectExplorer.openExternal",title:"Open in Browser",arguments:[r]},e.icon||this.favicons.getIconForUrl(r).then(p=>{if(p){let n=this.items.get(t);n&&(n.iconPath=p,this._onDidChangeTreeData.fire(n))}}).catch(()=>{})):s==="script"&&r&&(h.script={cmd:r,cwd:e.cwd,env:e.env},h.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[t]});return h}async runScriptById(e){var i,w;let t=this.items.get(e);if(!t||!t.script||this.running.has(e))return;let s=t.label;this.running.add(e),t.command=void 0,t.label=`${s}...`,this._onDidChangeTreeData.fire(t);let r=t.script.cwd?this.resolveFsPath(t.script.cwd):void 0;if(r&&!v.existsSync(r)){d.window.showErrorMessage(`Invalid cwd for script '${e}': ${r}`),this.running.delete(e),t.label=s,t.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[e]},this._onDidChangeTreeData.fire(t);return}let c={...process.env,...t.script.env||{}},a=(0,F.spawn)(t.script.cmd,{shell:!0,cwd:r,env:c}),m="",h="";(i=a.stdout)==null||i.on("data",f=>{m+=f instanceof Buffer?f.toString("utf8"):String(f)}),(w=a.stderr)==null||w.on("data",f=>{h+=f instanceof Buffer?f.toString("utf8"):String(f)});let p=!1,n=(f,j)=>{if(!p)if(p=!0,f){let g=(j??m).trim();d.window.showInformationMessage(g.length>0?g:`Script '${e}' completed successfully.`)}else{let g=(j??h).trim();d.window.showErrorMessage(g.length>0?g:`Script '${e}' failed.`)}this.running.delete(e),t.label=s,t.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[e]},this._onDidChangeTreeData.fire(t)};a.on("error",f=>{n(!1,`Failed to start script '${e}': ${f instanceof Error?f.message:String(f)}`)}),a.on("close",f=>{n(f===0)})}parseCodicon(e){let t=/^\$\(([^)]+)\)$/.exec(e.trim());return t?t[1]:null}resolveFsPath(e){var r;let t=e.trim();if(t.startsWith("~")&&process.env.HOME&&(t=t.replace("~",process.env.HOME)),x.isAbsolute(t))return t;let s=(r=d.workspace.workspaceFolders)==null?void 0:r[0];return s?x.join(s.uri.fsPath,t):t}},$=class extends d.TreeItem{constructor(e,t){super(e,t)}};function Z(l){let e=new T(l);o.window.registerTreeDataProvider("projectExplorer",e),o.window.onDidChangeActiveColorTheme(()=>{e.refresh()});let t=()=>{let r=o.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"",c=typeof r=="string"&&r.trim().length>0;o.commands.executeCommand("setContext","projectExplorer.hasBrainstorming",c)};t(),l.subscriptions.push(o.workspace.onDidChangeConfiguration(s=>{(s.affectsConfiguration("project-explorer.brainstormingDocPath")||s.affectsConfiguration("project-explorer"))&&t()})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.openBrainstormingDoc",async()=>{var c;let r=(o.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"").trim();if(!r){o.window.showWarningMessage("No brainstormingDocPath is configured.");return}try{let a;if(r.startsWith("/")||/^[a-zA-Z]:\\/.test(r)||r.startsWith("~")){let p=r.startsWith("~")&&process.env.HOME?r.replace("~",process.env.HOME):r;a=o.Uri.file(p)}else{let p=(c=o.workspace.workspaceFolders)==null?void 0:c[0];if(!p){o.window.showErrorMessage("No workspace is open to resolve a relative brainstormingDocPath.");return}a=o.Uri.joinPath(p.uri,r)}let h=await o.workspace.openTextDocument(a);await o.window.showTextDocument(h,{preview:!1})}catch(a){let m=a instanceof Error?a.message:String(a);o.window.showErrorMessage(`Unable to open brainstorming document: ${m}`)}})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.openExternal",async s=>{try{let r=o.Uri.parse(s);await o.env.openExternal(r)}catch(r){let c=r instanceof Error?r.message:String(r);o.window.showErrorMessage(`Unable to open URL: ${c}`)}})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.runScript",async s=>{await e.runScriptById(s)})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.openHelp",async()=>{let s=l.extension.id,r=o.Uri.parse(`vscode:extension/${s}`);await o.commands.executeCommand("vscode.open",r)})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.openSettings",async()=>{var r;(((r=o.workspace.workspaceFolders)==null?void 0:r.length)||0)>0?(await o.commands.executeCommand("workbench.action.openWorkspaceSettings"),await o.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer")):(o.window.showInformationMessage("Workspace settings are unavailable. Opening User settings."),await o.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer"))})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.configureTreeItems",async()=>{await o.commands.executeCommand("workbench.action.openSettings","project-explorer.treeItems")})),l.subscriptions.push(o.commands.registerCommand("projectExplorer.collapseAll",async()=>{await o.commands.executeCommand("workbench.actions.treeView.projectExplorer.collapseAll")}))}function G(){}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
