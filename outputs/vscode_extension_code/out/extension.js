"use strict";var W=Object.create;var j=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var L=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var H=(p,e)=>{for(var t in e)j(p,t,{get:e[t],enumerable:!0})},A=(p,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of _(e))!N.call(p,n)&&n!==t&&j(p,n,{get:()=>e[n],enumerable:!(s=O(e,n))||s.enumerable});return p};var E=(p,e,t)=>(t=p!=null?W(L(p)):{},A(e||!p||!p.__esModule?j(t,"default",{value:p,enumerable:!0}):t,p)),z=p=>A(j({},"__esModule",{value:!0}),p);var K={};H(K,{activate:()=>Z,deactivate:()=>G});module.exports=z(K);var o=E(require("vscode"));var d=E(require("vscode")),w=E(require("path")),g=E(require("fs")),V=E(require("https")),J=E(require("http")),R=require("child_process"),B=class{constructor(e){this.context=e;this.inflight=new Map;this.cacheDir=w.join(e.globalStorageUri.fsPath,"favicons"),this.indexPath=w.join(this.cacheDir,"index.json");try{g.mkdirSync(this.cacheDir,{recursive:!0})}catch{}this.index=this.readIndex()}async getIconForUrl(e){let t;try{let c=new URL(e);if(c.protocol!=="http:"&&c.protocol!=="https:")return;t=`${c.protocol}//${c.host}`}catch{return}let s=this.inflight.get(t);if(s)return s;let n=this.resolve(t,e).finally(()=>this.inflight.delete(t));return this.inflight.set(t,n),n}async resolve(e,t){let s=Date.now(),n=this.index[e];if(n){if(n.expiresAt&&n.expiresAt>s&&n.path&&g.existsSync(n.path))return d.Uri.file(n.path);if(n.negativeUntil&&n.negativeUntil>s)return}let c=`${e}/favicon.ico`,a=await this.tryFetchBuffer(c,5e3).catch(()=>{});if(a){let l=this.saveIcon(e,a,"ico");return this.index[e]={path:l,expiresAt:s+7*24*60*60*1e3},this.writeIndex(),d.Uri.file(l)}let h=await this.tryFetchText(t,5e3).catch(()=>{});if(h){let l=this.findIconHref(h);if(l)try{let f=new URL(t),r=new URL(l,f),i=await this.tryFetchBuffer(r.toString(),7e3).catch(()=>{});if(i){let y=this.guessExtFromUrlOrMime(r.toString()),v=this.saveIcon(e,i,y);return this.index[e]={path:v,expiresAt:s+7*24*60*60*1e3},this.writeIndex(),d.Uri.file(v)}}catch{}}this.index[e]={negativeUntil:s+24*60*60*1e3},this.writeIndex()}readIndex(){try{if(g.existsSync(this.indexPath)){let e=g.readFileSync(this.indexPath,"utf8");return JSON.parse(e)||{}}}catch{}return{}}writeIndex(){try{g.writeFileSync(this.indexPath,JSON.stringify(this.index,null,2),"utf8")}catch{}}saveIcon(e,t,s){let n=e.replace(/[^a-z0-9]/gi,"_"),c=w.join(this.cacheDir,`${n}.${s}`);return g.writeFileSync(c,t),c}guessExtFromUrlOrMime(e){let t=e.toLowerCase();return t.endsWith(".png")?"png":t.endsWith(".svg")||t.includes("image/svg")?"svg":t.endsWith(".jpg")||t.endsWith(".jpeg")?"jpg":t.endsWith(".ico")?"ico":"png"}async tryFetchText(e,t){return(await this.tryFetchBuffer(e,t)).toString("utf8")}async tryFetchBuffer(e,t){return new Promise((s,n)=>{let c=!1,a=setTimeout(()=>{c=!0,f==null||f.destroy(new Error("timeout")),n(new Error("timeout"))},t),f=(new URL(e).protocol==="https:"?V:J).get(e,r=>{let i=r.statusCode||0;if([301,302,303,307,308].includes(i)&&r.headers.location){clearTimeout(a),this.tryFetchBuffer(new URL(r.headers.location,e).toString(),t).then(s,n),r.resume();return}if(i<200||i>=300){clearTimeout(a),n(new Error(`HTTP ${i}`)),r.resume();return}let y=[];r.on("data",v=>y.push(Buffer.isBuffer(v)?v:Buffer.from(v))),r.on("end",()=>{c||(clearTimeout(a),s(Buffer.concat(y)))}),r.on("error",v=>{c||(clearTimeout(a),n(v))})});f.on("error",r=>{c||(clearTimeout(a),n(r))})})}findIconHref(e){let t=/<link\s+[^>]*rel=["']([^"']*)["'][^>]*href=["']([^"']+)["'][^>]*>/gi,s,n=[];for(;s=t.exec(e);){let c=s[1].toLowerCase(),a=s[2];c.includes("icon")&&n.push(a)}return n[0]}},k=class{constructor(e){this._onDidChangeTreeData=new d.EventEmitter;this.onDidChangeTreeData=this._onDidChangeTreeData.event;this.items=new Map;this.parentById=new Map;this.childrenById=new Map;this.roots=[];this.running=new Set;this.scriptIds=new Set;this.favicons=new B(e),d.workspace.onDidChangeConfiguration(t=>{(t.affectsConfiguration("project-explorer.treeItems")||t.affectsConfiguration("project-explorer"))&&this.refresh()})}refresh(){this.rebuild(),this._onDidChangeTreeData.fire()}getTreeItem(e){return e}async getChildren(e){return this.items.size===0&&this.roots.length===0&&this.rebuild(),e?(this.childrenById.get(e.id||"")||[]).map(s=>this.items.get(s)).filter(Boolean):this.roots.map(s=>this.items.get(s)).filter(Boolean)}rebuild(){let e=new Set,s=d.workspace.getConfiguration("project-explorer").get("treeItems");this.items.clear(),this.parentById.clear(),this.childrenById.clear(),this.roots=[],this.scriptIds.clear();let n=Array.isArray(s)?s:[];Array.isArray(s)||e.add("`project-explorer.treeItems` is not an array. Ignoring.");let c=[];for(let r of n){if(!r||typeof r!="object"){e.add("Ignored non-object entry in `project-explorer.treeItems`.");continue}let i=typeof r.id=="string"&&r.id.trim()?r.id.trim():"";if(!i){e.add("Ignored item with missing `id`.");continue}if(this.items.has(i)||c.find(u=>u.id===i)){e.add(`Duplicate id '${i}' found. Only the first occurrence will be used.`);continue}let y=typeof r.parentId=="string"&&r.parentId.trim()?r.parentId.trim():void 0,v=typeof r.label=="string"&&r.label.trim()?r.label.trim():void 0,F=typeof r.icon=="string"&&r.icon.trim()?r.icon.trim():void 0,x,I,T=r.typeAndPath,P=r.type_plus_path,b=typeof T=="string"&&T.trim()?T.trim():typeof P=="string"&&P.trim()?P.trim():"";if(!b&&typeof P=="string"&&P.trim()&&e.add(`Item '${i}' uses deprecated 'type_plus_path'. Please rename to 'typeAndPath'.`),b){let u=b.indexOf(":");if(u>0&&u<b.length-1){let m=b.slice(0,u),S=b.slice(u+1);["file","folder","url","script"].includes(m)?(x=m,I=S):e.add(`Item '${i}' has unknown type '${m}'. Treating as label-only item.`)}else e.add(`Item '${i}' has invalid typeAndPath '${b}'. Treating as label-only item.`)}let C=v;if(!C)if(x&&I)if(x==="url")try{let u=new URL(I),m=u.pathname.split("/").filter(Boolean);C=m.length>0?decodeURIComponent(m[m.length-1]):u.hostname}catch{C=I}else x==="file"||x==="folder"?C=w.basename(this.resolveFsPath(I)):x==="script"&&(C=I);else C=i;let U={id:i,type:x,target:I,label:C,icon:F,parentId:y};if(x==="script"){let u=typeof r.cwd=="string"&&r.cwd.trim()?r.cwd.trim():void 0,m=r.env,S;if(m&&typeof m=="object"&&!Array.isArray(m)){S={};for(let[M,$]of Object.entries(m))typeof $=="string"&&(S[M]=$)}U.cwd=u,U.env=S,this.scriptIds.add(i)}c.push(U)}for(let r of c){let i=this.makeNode(r);this.items.set(r.id,i),this.parentById.set(r.id,r.parentId)}for(let[r,i]of Array.from(this.parentById.entries()))i&&this.scriptIds.has(i)&&(e.add(`Item '${r}' cannot have script parent '${i}'. Rendering as top-level.`),this.parentById.set(r,void 0));let a=new Set,h=new Set,l=new Set,f=r=>{if(h.has(r)){l.add(r);return}if(a.has(r))return;a.add(r),h.add(r);let i=this.parentById.get(r);i&&this.items.has(i)&&f(i),h.delete(r)};for(let r of this.items.keys())f(r);l.size>0&&e.add("Detected cyclical parent relationships. Items in cycles will be rendered at top level.");for(let r of l)this.parentById.delete(r);for(let r of this.items.keys())this.childrenById.set(r,[]);for(let[r,i]of this.parentById)i&&this.items.has(i)&&this.childrenById.get(i).push(r);for(let r of this.items.keys()){let i=this.parentById.get(r);(!i||!this.items.has(i))&&(i&&!this.items.has(i)&&e.add(`Parent '${i}' not found for item '${r}'. Rendering as top-level.`),this.roots.push(r))}for(let[r,i]of this.items){let y=(this.childrenById.get(r)||[]).length>0;i.collapsibleState=y?d.TreeItemCollapsibleState.Collapsed:d.TreeItemCollapsibleState.None,!i.command&&!i.iconPath&&!("script"in i)&&(i.iconPath=new d.ThemeIcon("folder"))}e.size>0&&d.window.showWarningMessage(Array.from(e).join(" "))}makeNode(e){let{id:t}=e,s=e.type,n=e.target,c=e.label,a,h=new d.MarkdownString;if(s&&n?h.appendText(`${s}:${n}`):h.appendText(c),h.isTrusted=!0,e.icon){let f=this.parseCodicon(e.icon);if(f)a=new d.ThemeIcon(f);else{let r=this.resolveFsPath(e.icon);g.existsSync(r)?a=d.Uri.file(r):d.window.showWarningMessage(`Icon path not found for item '${t}': ${e.icon}. Falling back to default icon.`)}}else s==="url"?a=new d.ThemeIcon("globe"):s==="script"&&(a=new d.ThemeIcon("run"));let l=new D(c,d.TreeItemCollapsibleState.None);if(l.id=t,l.tooltip=h,l.iconPath=a,s==="file"&&n){let f=d.Uri.file(this.resolveFsPath(n));l.command={command:"vscode.open",title:"Open File",arguments:[f]}}else if(s==="folder"&&n){let f=d.Uri.file(this.resolveFsPath(n));l.command={command:"revealInExplorer",title:"Reveal in Explorer",arguments:[f]}}else s==="url"&&n?(l.command={command:"projectExplorer.openExternal",title:"Open in Browser",arguments:[n]},e.icon||this.favicons.getIconForUrl(n).then(f=>{if(f){let r=this.items.get(t);r&&(r.iconPath=f,this._onDidChangeTreeData.fire(r))}}).catch(()=>{})):s==="script"&&n&&(l.script={cmd:n,cwd:e.cwd,env:e.env},l.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[t]});return l}async runScriptById(e){let t=this.items.get(e);if(!t||!t.script||this.running.has(e))return;let s=t.label;this.running.add(e),t.command=void 0,t.label=`${s}...`,this._onDidChangeTreeData.fire(t);let n=t.script.cwd?this.resolveFsPath(t.script.cwd):void 0;if(n&&!g.existsSync(n)){d.window.showErrorMessage(`Invalid cwd for script '${e}': ${n}`),this.running.delete(e),t.label=s,t.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[e]},this._onDidChangeTreeData.fire(t);return}let c={...process.env,...t.script.env||{}},a=(0,R.spawn)(t.script.cmd,{shell:!0,cwd:n,env:c});a.on("error",l=>{d.window.showErrorMessage(`Failed to start script '${e}': ${l instanceof Error?l.message:String(l)}`)});let h=()=>{this.running.delete(e),t.label=s,t.command={command:"projectExplorer.runScript",title:"Run Script",arguments:[e]},this._onDidChangeTreeData.fire(t)};a.on("exit",()=>h()),a.on("close",()=>h())}parseCodicon(e){let t=/^\$\(([^)]+)\)$/.exec(e.trim());return t?t[1]:null}resolveFsPath(e){var n;let t=e.trim();if(t.startsWith("~")&&process.env.HOME&&(t=t.replace("~",process.env.HOME)),w.isAbsolute(t))return t;let s=(n=d.workspace.workspaceFolders)==null?void 0:n[0];return s?w.join(s.uri.fsPath,t):t}},D=class extends d.TreeItem{constructor(e,t){super(e,t)}};function Z(p){let e=new k(p);o.window.registerTreeDataProvider("projectExplorer",e),o.window.onDidChangeActiveColorTheme(()=>{e.refresh()});let t=()=>{let n=o.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"",c=typeof n=="string"&&n.trim().length>0;o.commands.executeCommand("setContext","projectExplorer.hasBrainstorming",c)};t(),p.subscriptions.push(o.workspace.onDidChangeConfiguration(s=>{(s.affectsConfiguration("project-explorer.brainstormingDocPath")||s.affectsConfiguration("project-explorer"))&&t()})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.openBrainstormingDoc",async()=>{var c;let n=(o.workspace.getConfiguration("project-explorer").get("brainstormingDocPath")||"").trim();if(!n){o.window.showWarningMessage("No brainstormingDocPath is configured.");return}try{let a;if(n.startsWith("/")||/^[a-zA-Z]:\\/.test(n)||n.startsWith("~")){let f=n.startsWith("~")&&process.env.HOME?n.replace("~",process.env.HOME):n;a=o.Uri.file(f)}else{let f=(c=o.workspace.workspaceFolders)==null?void 0:c[0];if(!f){o.window.showErrorMessage("No workspace is open to resolve a relative brainstormingDocPath.");return}a=o.Uri.joinPath(f.uri,n)}let l=await o.workspace.openTextDocument(a);await o.window.showTextDocument(l,{preview:!1})}catch(a){let h=a instanceof Error?a.message:String(a);o.window.showErrorMessage(`Unable to open brainstorming document: ${h}`)}})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.openExternal",async s=>{try{let n=o.Uri.parse(s);await o.env.openExternal(n)}catch(n){let c=n instanceof Error?n.message:String(n);o.window.showErrorMessage(`Unable to open URL: ${c}`)}})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.runScript",async s=>{await e.runScriptById(s)})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.openHelp",async()=>{let s=p.extension.id,n=o.Uri.parse(`vscode:extension/${s}`);await o.commands.executeCommand("vscode.open",n)})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.openSettings",async()=>{var n;(((n=o.workspace.workspaceFolders)==null?void 0:n.length)||0)>0?(await o.commands.executeCommand("workbench.action.openWorkspaceSettings"),await o.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer")):(o.window.showInformationMessage("Workspace settings are unavailable. Opening User settings."),await o.commands.executeCommand("workbench.action.openSettings","@ext:ftl-tools.project-explorer"))})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.configureTreeItems",async()=>{await o.commands.executeCommand("workbench.action.openSettings","project-explorer.treeItems")})),p.subscriptions.push(o.commands.registerCommand("projectExplorer.collapseAll",async()=>{await o.commands.executeCommand("workbench.actions.treeView.projectExplorer.collapseAll")}))}function G(){}0&&(module.exports={activate,deactivate});
//# sourceMappingURL=extension.js.map
